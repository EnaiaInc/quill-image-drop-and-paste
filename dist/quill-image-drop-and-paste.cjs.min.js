"use strict";var e={generateFilename:()=>btoa(String(1e6*Math.random())+String(+new Date)).replace("=",""),urlIsImage(e,t=3e3){return this.validURL(e)?/\.(jpeg|jpg|gif|png|webp|tiff|bmp)$/.test(e)?Promise.resolve(!0):new Promise(((i,r)=>{let a;const n=new Image;n.onerror=n.onabort=()=>{clearTimeout(a),r(!1)},n.onload=()=>{clearTimeout(a),i(!0)},a=setTimeout((()=>{n.src="//!/an/invalid.jpg",r(!1)}),t),n.src=e})):Promise.reject(!1)},validURL(e){try{return Boolean(new URL(e))}catch(e){return!1}},isRichText(e){let t=!1;return Array.prototype.forEach.call(e,(e=>{e.type.match(/^text\/html$/i)&&(t=!0)})),t},resolveDataUrl(e,t){let i="";return"string"==typeof e?i=e:e instanceof ArrayBuffer&&(i=this.arrayBufferToBase64Url(e,t)),i},binaryStringToArrayBuffer(e){const t=e.length,i=new ArrayBuffer(t),r=new Uint8Array(i);let a=-1;for(;++a<t;)r[a]=e.charCodeAt(a);return i},arrayBufferToBase64Url:(e,t)=>`data:${t};base64,`+btoa(new Uint8Array(e).reduce(((e,t)=>e+String.fromCharCode(t)),"")),copyText(e,t=document.body){const i=document.createElement("textarea"),r=document.activeElement;i.value=e,i.setAttribute("readonly",""),i.style.position="absolute",i.style.left="-9999px",i.style.fontSize="12pt";const a=document.getSelection();let n=!1;a&&a.rangeCount>0&&(n=a.getRangeAt(0)),t.append(i),i.select(),i.selectionStart=0,i.selectionEnd=e.length;let s=!1;try{s=document.execCommand("copy")}catch(e){}return i.remove(),a&&n&&(a.removeAllRanges(),a.addRange(n)),r&&r.focus(),s},isType:(e,t)=>Object.prototype.toString.call(e)===`[object ${t}]`};class t{constructor(e,t,i){this.dataUrl=e,this.type=t,this.name=i||""}}class i extends t{constructor(t,i,r){super(t,i,r),this.dataUrl=t,this.type=i,this.name=r||`${e.generateFilename()}.${this.getSuffix()}`}minify(t){return new Promise(((r,a)=>{const n=t.maxWidth||800,s=t.maxHeight||800,o=t.quality||.8;if(!this.dataUrl)return a({message:"[error] QuillImageDropAndPaste: Fail to minify the image, dataUrl should not be empty."});const l=new Image;l.onload=()=>{const e=l.width,t=l.height;e>t?e>n&&(l.height=t*n/e,l.width=n):t>s&&(l.width=e*s/t,l.height=s);const h=document.createElement("canvas");h.width=l.width,h.height=l.height;const d=h.getContext("2d");if(d){d.drawImage(l,0,0,l.width,l.height);const e=this.type||"image/png",t=h.toDataURL(e,o);r(new i(t,e,this.name))}else a({message:"[error] QuillImageDropAndPaste: Fail to minify the image, create canvas context failure."})},l.src=e.resolveDataUrl(this.dataUrl,this.type)}))}toFile(e){return e=e||this.name,window.File?new File([this.toBlob()],e,{type:this.type}):(console.error("[error] QuillImageDropAndPaste: Your browser didnot support File API."),null)}toBlob(){const t=e.resolveDataUrl(this.dataUrl,this.type).replace(/^[^,]+,/,""),i=e.binaryStringToArrayBuffer(atob(t));return this.createBlob([i],{type:this.type})}createBlob(e,t){t||(t={}),"string"==typeof t&&(t={type:t});try{return new Blob(e,t)}catch(i){if("TypeError"!==i.name)throw i;const r=new("BlobBuilder"in window?window.BlobBuilder:"MSBlobBuilder"in window?window.MSBlobBuilder:"MozBlobBuilder"in window?window.MozBlobBuilder:window.WebKitBlobBuilder);for(let t=0;t<e.length;t++)r.append(e[t]);return r.getBlob(t.type)}}getSuffix(){const e=this.type.match(/^image\/(\w+)$/);return e?e[1]:"png"}}class r{constructor(e,t){this.quill=e,this.option=t}}class a extends r{constructor(e,t){super(e,t),this.quill=e,this.option=t,this.handleDrop=this.handleDrop.bind(this),this.handlePaste=this.handlePaste.bind(this),this.insert=this.insert.bind(this),this.quill.root.addEventListener("drop",this.handleDrop,!1),this.quill.root.addEventListener("paste",this.handlePaste,!1)}handleDrop(t){if(t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length){if(t.preventDefault(),document.caretRangeFromPoint){const e=document.getSelection(),i=document.caretRangeFromPoint(t.clientX,t.clientY);e&&i&&e.setBaseAndExtent(i.startContainer,i.startOffset,i.startContainer,i.startOffset)}this.readFiles(t.dataTransfer.files,((t,r="image/png",a)=>{"function"==typeof this.option.handler?this.option.handler.call(this,t,r,new i(t,r,a)):this.insert.call(this,e.resolveDataUrl(t,r),r)}),t)}}handlePaste(t){if(console.log("paste",t),t.clipboardData&&t.clipboardData.items&&t.clipboardData.items.length){if(e.isRichText(t.clipboardData.items))return;this.readFiles(t.clipboardData.items,((t,r="image/png")=>{"function"==typeof this.option.handler?this.option.handler.call(this,t,r,new i(t,r)):this.insert(e.resolveDataUrl(t,r),"image")}),t)}}readFiles(t,i,r){Array.prototype.forEach.call(t,(t=>{e.isType(t,"DataTransferItem")?this.handleDataTransfer(t,i,r):t instanceof File&&this.handleDroppedFile(t,i,r)}))}handleDataTransfer(t,i,r){const a=this,{type:n}=t;if(n.match(/^image\/(gif|jpe?g|a?png|svg|webp|bmp)/i)){r.preventDefault();const e=new FileReader;e.onload=e=>{e.target&&e.target.result&&i(e.target.result,n)};const a=t.getAsFile?t.getAsFile():t;a instanceof Blob&&e.readAsDataURL(a)}else n.match(/^text\/plain$/i)&&t.getAsString((t=>{const i=this.getIndex();e.urlIsImage(t).then((()=>{const e=this.getIndex();this.quill.deleteText(i,e-i,"user"),a.insert(t,"image")})).catch((()=>{}))}))}handleDroppedFile(e,t,i){const{type:r,name:a=""}=e;if(r.match(/^image\/(gif|jpe?g|a?png|svg|webp|bmp)/i)){i.preventDefault();const n=new FileReader;n.onload=e=>{e.target&&e.target.result&&t(e.target.result,r,a)},n.readAsDataURL(e)}}insert(e,t){const i=this.getIndex();let r;"image"===t?(r=i+1,this.quill.insertEmbed(i,t,e,"user")):"text"===t&&(r=i+e.length,this.quill.insertText(i,e,"user")),setTimeout((()=>{this.quill.setSelection(r)}))}getIndex(){let e=(this.quill.getSelection(!0)||{}).index;return(void 0===e||e<0)&&(e=this.quill.getLength()),e}}a.ImageData=i,window.QuillImageDropAndPaste=a,"Quill"in window&&window.Quill.register("modules/imageDropAndPaste",a),module.exports=a;
//# sourceMappingURL=quill-image-drop-and-paste.cjs.min.js.map
